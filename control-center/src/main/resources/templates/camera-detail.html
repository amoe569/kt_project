<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${camera.name} + ' - CCTV AI ê´€ì œ ì‹œìŠ¤í…œ'">ì¹´ë©”ë¼ ìƒì„¸ - CCTV AI ê´€ì œ ì‹œìŠ¤í…œ</title>
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .app-title {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .user-info {
            float: right;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .back-link {
            color: #ffffff;
            text-decoration: none;
            font-size: 0.9rem;
            opacity: 0.8;
        }
        
        .back-link:hover {
            opacity: 1;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
        }
        
        .sidebar {
            width: 250px;
            background-color: #2d2d2d;
            padding: 1rem;
            border-right: 1px solid #444;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }
        
        .sidebar-menu a {
            display: block;
            padding: 0.75rem 1rem;
            color: #ffffff;
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        .sidebar-menu a:hover {
            background-color: #444;
        }
        
        .sidebar-menu a.active {
            background-color: #667eea;
        }
        
        .content-area {
            flex: 1;
            padding: 2rem;
            overflow: hidden;
        }
        
        .camera-header {
            background-color: #2d2d2d;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        .camera-title {
            font-size: 2rem;
            margin-bottom: 1rem;
            color: #667eea;
        }
        
        .camera-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(100px, 1fr));
            gap: 0.3rem;
        }
        
        .info-item {
            background-color: #3d3d3d;
            padding: 0.3rem;
            border-radius: 6px;
        }
        
        .info-label {
            font-size: 0.7rem;
            color: #888;
            margin-bottom: 0.2rem;
        }
        
        .info-value {
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .main-content {
            display: grid;
            grid-template-columns: 2fr 1fr;
            gap: 2rem;
            height: calc(100vh - 200px);
            min-height: 500px;
            overflow: hidden;
        }
        
        .video-container {
            background-color: #2d2d2d;
            border-radius: 12px;
            padding: 0.5rem;
            position: relative;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        
        .video-title {
            font-size: 1rem;
            margin-bottom: 0.5rem;
            color: #667eea;
            flex-shrink: 0;
        }
        
        .video-stream {
            width: 100%;
            height: 0;
            padding-bottom: 56.25%; /* 16:9 ë¹„ìœ¨ */
            background-color: #000;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            position: relative;
            flex: 1;
            max-height: 400px; /* ìµœëŒ€ ë†’ì´ ì œí•œ */
        }
        
        .video-stream img {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            object-fit: contain;
            border-radius: 8px;
        }
        
        .events-panel {
            background-color: #2d2d2d;
            border-radius: 12px;
            padding: 1rem;
            overflow: hidden;
        }
        
        .events-title {
            font-size: 1.2rem;
            margin-bottom: 1rem;
            color: #667eea;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .events-list {
            height: calc(100% - 160px); /* ìƒíƒœ ë³€ê²½ íŒ¨ë„ ê³µê°„ í™•ë³´ */
            max-height: 300px;
            overflow-y: auto;
            padding-right: 5px;
        }
        
        .event-item {
            background-color: #3d3d3d;
            padding: 1rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }
        
        .event-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .event-type {
            font-weight: 600;
            color: #667eea;
        }
        
        .event-time {
            font-size: 0.8rem;
            color: #888;
        }
        
        .event-details {
            font-size: 0.9rem;
        }
        
        .event-score {
            color: #ffc107;
            font-weight: 600;
        }
        
        .no-events {
            text-align: center;
            color: #888;
            padding: 2rem;
        }
        
        .status-badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-size: 0.8rem;
            font-weight: 600;
        }
        
        .status-online { background-color: #28a745; }
        .status-offline { background-color: #6c757d; }
        .status-maintenance { background-color: #ffc107; color: #000; }
        .status-error { background-color: #dc3545; }
        .status-warning { background-color: #fd7e14; }
        
        /* ê¸°ì¡´ í´ë˜ìŠ¤ í˜¸í™˜ì„± ìœ ì§€ */
        .status-normal { background-color: #28a745; }
        .status-alert { background-color: #dc3545; }
        .status-fault { background-color: #ffc107; color: #000; }
        
        .error-message {
            background-color: #dc3545;
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            margin: 2rem 0;
        }
        
        .status-control-panel {
            background-color: #3d3d3d;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1.5rem;
            border: 1px solid #667eea;
        }
        
        .status-control-title {
            font-size: 1.1rem;
            color: #667eea;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }
        
        .status-control-form {
            display: flex;
            gap: 1rem;
            align-items: center;
            flex-wrap: wrap;
        }
        
        .status-select {
            padding: 0.5rem;
            background-color: #3d3d3d;
            border: 1px solid #555;
            border-radius: 6px;
            color: white;
            font-size: 0.9rem;
            min-width: 150px;
        }
        
        .status-select:focus {
            outline: none;
            border-color: #667eea;
        }
        
        .status-change-btn {
            padding: 0.5rem 1rem;
            background-color: #667eea;
            border: none;
            border-radius: 6px;
            color: white;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: background-color 0.3s;
        }
        
        .status-change-btn:hover {
            background-color: #5a6fd8;
        }
        
        .status-change-btn:disabled {
            background-color: #666;
            cursor: not-allowed;
        }
        
        .status-result {
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 6px;
            font-size: 0.9rem;
            display: none;
        }
        
        .status-result.success {
            background-color: #2d5a2d;
            border: 1px solid #4CAF50;
            color: #4CAF50;
        }
        
        .status-result.error {
            background-color: #5a2d2d;
            border: 1px solid #f44336;
            color: #f44336;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="app-title">
            <a href="/" class="back-link">â†</a>
            CCTV AI ê´€ì œ ì‹œìŠ¤í…œ
        </div>
        <div class="user-info" th:text="${userEmail}">admin@example.com</div>
    </header>
    
    <div class="main-container">
        <nav class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="/" class="active">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="/events">ì´ë²¤íŠ¸ ê´€ë¦¬</a></li>
                <li><a href="/videos">ì €ì¥ ì˜ìƒ</a></li>
            </ul>
        </nav>
        
        <main class="content-area">
            <!-- ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ -->
            <div th:if="${error}" class="error-message" th:text="${error}">
                ì¹´ë©”ë¼ ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤
            </div>
            
            <!-- ì¹´ë©”ë¼ ì •ë³´ê°€ ìˆì„ ë•Œë§Œ í‘œì‹œ -->
            <div th:if="${camera}" class="camera-header">
                <h1 class="camera-title" th:text="${camera.name}">ì¹´ë©”ë¼ ì´ë¦„</h1>
                <div class="camera-info">
                    <div class="info-item">
                        <div class="info-label">ìƒíƒœ</div>
                        <div class="info-value">
                            <span class="status-badge" 
                                  th:classappend="'status-' + ${#strings.toLowerCase(camera.status)}"
                                  th:text="${camera.status}">NORMAL</span>
                        </div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ìœ„ì¹˜</div>
                        <div class="info-value" th:text="${camera.lat + ', ' + camera.lng}">37.5665, 126.9780</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">RTSP URL</div>
                        <div class="info-value" th:text="${camera.rtspUrl ?: 'N/A'}">RTSP URL</div>
                    </div>
                    <div class="info-item">
                        <div class="info-label">ë“±ë¡ì¼</div>
                        <div class="info-value" th:text="${#temporals.format(camera.createdAt, 'yyyy-MM-dd HH:mm')}">2024-01-01</div>
                    </div>
                </div>
            </div>
            

            
            <div class="main-content">
                <div class="video-container">
                    <h3 class="video-title">ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼</h3>
                    <div class="video-stream">
                        <img th:if="${camera}" 
                             id="stream-image"
                             th:src="'http://localhost:5001/stream/' + ${camera.id}" 
                             alt="ì‹¤ì‹œê°„ ìŠ¤íŠ¸ë¦¼"
                             crossorigin="anonymous">
                        <div id="stream-status" style="display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%; flex-direction: column; align-items: center; justify-content: center; color: #888; background: rgba(0,0,0,0.8);">
                            <div style="font-size: 2rem; margin-bottom: 1rem;">ğŸ“¹</div>
                            <div id="status-message">ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì¤‘...</div>
                            <div style="font-size: 0.8rem; margin-top: 0.5rem;">Python Detectorê°€ ì‹¤í–‰ ì¤‘ì¸ì§€ í™•ì¸í•˜ì„¸ìš”</div>
                            <button id="retry-stream" style="margin-top: 1rem; padding: 0.5rem 1rem; background: #667eea; border: none; border-radius: 5px; color: white; cursor: pointer;">ì¬ì‹œë„</button>
                            <div style="margin-top: 1rem; font-size: 0.8rem; color: #aaa;">
                                <p>ğŸ”— ìŠ¤íŠ¸ë¦¼ URL: <code th:text="'http://localhost:5001/stream/' + ${camera.id}">http://localhost:5001/stream/cam-001</code></p>
                                <p>ğŸ’¡ ìƒˆ íƒ­ì—ì„œ ì§ì ‘ ì—´ì–´ë³´ì„¸ìš”</p>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div class="events-panel">
                    <!-- ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½ íŒ¨ë„ -->
                    <div th:if="${camera}" class="status-control-panel">
                        <div class="status-control-title">
                            âš™ï¸ ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½
                        </div>
                        <div class="status-control-form">
                            <select id="statusSelect" class="status-select">
                                <option value="">ìƒíƒœ ì„ íƒ</option>
                                <option value="ONLINE" th:selected="${camera.status == 'ONLINE'}">ğŸŸ¢ ì˜¨ë¼ì¸</option>
                                <option value="OFFLINE" th:selected="${camera.status == 'OFFLINE'}">âš« ì˜¤í”„ë¼ì¸</option>
                                <option value="MAINTENANCE" th:selected="${camera.status == 'MAINTENANCE'}">ğŸ”§ ì ê²€ì¤‘</option>
                                <option value="ERROR" th:selected="${camera.status == 'ERROR'}">ğŸ”´ ì˜¤ë¥˜</option>
                                <option value="WARNING" th:selected="${camera.status == 'WARNING'}">ğŸŸ  ê²½ê³ </option>
                            </select>
                            <button id="changeStatusBtn" class="status-change-btn" onclick="changeCameraStatus()">ìƒíƒœ ë³€ê²½</button>
                        </div>
                        <div id="statusResult" class="status-result"></div>
                    </div>
                    
                    <h3 class="events-title">
                        ì‹¤ì‹œê°„ ì´ë²¤íŠ¸
                        <span id="event-count">0</span>
                    </h3>
                    <div class="events-list" id="events-list">
                        <div class="no-events">ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>
                    </div>
                </div>
            </div>
        </main>
    </div>
    
    <script th:inline="javascript">
        // ì¹´ë©”ë¼ ID ê°€ì ¸ì˜¤ê¸°
        const cameraId = /*[[${camera?.id}]]*/ null;
        
        if (cameraId) {
            // ìŠ¤íŠ¸ë¦¼ ìƒíƒœ ê´€ë¦¬
            const streamImg = document.getElementById('stream-image');
            const streamStatus = document.getElementById('stream-status');
            const statusMessage = document.getElementById('status-message');
            const retryButton = document.getElementById('retry-stream');
            
            // ìŠ¤íŠ¸ë¦¼ ìƒíƒœ ì²´í¬ í•¨ìˆ˜
            function checkStreamStatus() {
                const streamUrl = `http://localhost:5001/stream/${cameraId}`;
                console.log('ìŠ¤íŠ¸ë¦¼ URL í™•ì¸:', streamUrl);
                
                // ì´ë¯¸ì§€ ë¡œë“œ ìƒíƒœ ì²´í¬
                if (streamImg.complete && streamImg.naturalHeight !== 0) {
                    streamImg.style.display = 'block';
                    streamStatus.style.display = 'none';
                    statusMessage.textContent = 'ìŠ¤íŠ¸ë¦¼ ì—°ê²°ë¨';
                    console.log('ìŠ¤íŠ¸ë¦¼ ì •ìƒ ì—°ê²°');
                } else {
                    streamImg.style.display = 'none';
                    streamStatus.style.display = 'flex';
                    statusMessage.textContent = 'ìŠ¤íŠ¸ë¦¼ ì—°ê²° ëŒ€ê¸° ì¤‘...';
                    console.log('ìŠ¤íŠ¸ë¦¼ ì—°ê²° ëŒ€ê¸°');
                }
            }
            
            let streamReconnectTimer;
            let streamCheckTimer;
            let lastStreamUpdate = Date.now();
            
            // ìŠ¤íŠ¸ë¦¼ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ ì‹œ
            streamImg.onload = function() {
                console.log('ìŠ¤íŠ¸ë¦¼ ì´ë¯¸ì§€ ë¡œë“œ ì„±ê³µ');
                lastStreamUpdate = Date.now();
                checkStreamStatus();
                
                // ìë™ ì¬ì—°ê²° íƒ€ì´ë¨¸ ì¬ì„¤ì •
                if (streamReconnectTimer) {
                    clearTimeout(streamReconnectTimer);
                }
                streamReconnectTimer = setTimeout(() => {
                    console.log('30ì´ˆ íƒ€ì´ë¨¸ - ìŠ¤íŠ¸ë¦¼ ìë™ ì¬ì—°ê²° ì‹œë„');
                    reconnectStream();
                }, 30000); // 30ì´ˆë§ˆë‹¤ ìë™ ì¬ì—°ê²°
            };
            
            // ìŠ¤íŠ¸ë¦¼ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨ ì‹œ
            streamImg.onerror = function() {
                console.log('ìŠ¤íŠ¸ë¦¼ ì´ë¯¸ì§€ ë¡œë“œ ì‹¤íŒ¨');
                streamImg.style.display = 'none';
                streamStatus.style.display = 'flex';
                statusMessage.textContent = 'ìŠ¤íŠ¸ë¦¼ ì—°ê²° ì‹¤íŒ¨';
                
                // 5ì´ˆ í›„ ìë™ ì¬ì‹œë„
                setTimeout(() => {
                    console.log('ìŠ¤íŠ¸ë¦¼ ì˜¤ë¥˜ - 5ì´ˆ í›„ ìë™ ì¬ì‹œë„');
                    reconnectStream();
                }, 5000);
            };
            
            // ì¬ì‹œë„ ë²„íŠ¼ í´ë¦­ ì‹œ
            retryButton.onclick = function() {
                statusMessage.textContent = 'ì¬ì—°ê²° ì‹œë„ ì¤‘...';
                reconnectStream();
            };
            
            // ìŠ¤íŠ¸ë¦¼ ì¬ì—°ê²° í•¨ìˆ˜ (ìºì‹œ ë²„ìŠ¤íŒ… í¬í•¨)
            function reconnectStream() {
                // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
                if (streamReconnectTimer) {
                    clearTimeout(streamReconnectTimer);
                }
                
                const timestamp = new Date().getTime();
                const randomId = Math.random().toString(36).substr(2, 9);
                const baseUrl = `http://localhost:5001/stream/${cameraId}`;
                const newUrl = `${baseUrl}?t=${timestamp}&r=${randomId}`;
                
                console.log('ìŠ¤íŠ¸ë¦¼ ì¬ì—°ê²° ì‹œë„:', newUrl);
                
                // ì´ì „ ì´ë¯¸ì§€ ì™„ì „íˆ ì œê±°
                streamImg.src = '';
                streamImg.removeAttribute('src');
                streamImg.style.display = 'none';
                streamStatus.style.display = 'flex';
                statusMessage.textContent = 'ì¬ì—°ê²° ì‹œë„ ì¤‘...';
                
                // ì§§ì€ ì§€ì—° í›„ ìƒˆ URL ì„¤ì •
                setTimeout(() => {
                    streamImg.src = newUrl;
                    lastStreamUpdate = Date.now();
                }, 1000);
            }
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ìŠ¤íŠ¸ë¦¼ URLì— ìºì‹œ ë²„ìŠ¤íŒ… ì ìš©
            function initializeStream() {
                const timestamp = new Date().getTime();
                const baseUrl = `http://localhost:5001/stream/${cameraId}`;
                const urlWithCacheBusting = `${baseUrl}?t=${timestamp}`;
                
                console.log('ì´ˆê¸° ìŠ¤íŠ¸ë¦¼ URL ì„¤ì •:', urlWithCacheBusting);
                streamImg.src = urlWithCacheBusting;
            }
            
            // ì´ˆê¸° ìŠ¤íŠ¸ë¦¼ ì„¤ì •
            initializeStream();
            
            // ì´ˆê¸° ìŠ¤íŠ¸ë¦¼ ìƒíƒœ ì²´í¬
            setTimeout(checkStreamStatus, 2000);
            
            // ì£¼ê¸°ì  ìŠ¤íŠ¸ë¦¼ ìƒíƒœ ëª¨ë‹ˆí„°ë§ (10ì´ˆë§ˆë‹¤)
            streamCheckTimer = setInterval(() => {
                const timeSinceLastUpdate = Date.now() - lastStreamUpdate;
                console.log(`ìŠ¤íŠ¸ë¦¼ ìƒíƒœ ì²´í¬: ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸ë¡œë¶€í„° ${Math.floor(timeSinceLastUpdate/1000)}ì´ˆ ê²½ê³¼`);
                
                // 45ì´ˆ ì´ìƒ ì—…ë°ì´íŠ¸ê°€ ì—†ìœ¼ë©´ ì¬ì—°ê²°
                if (timeSinceLastUpdate > 45000) {
                    console.log('ìŠ¤íŠ¸ë¦¼ íƒ€ì„ì•„ì›ƒ ê°ì§€ - ìë™ ì¬ì—°ê²°');
                    reconnectStream();
                }
            }, 10000); // 10ì´ˆë§ˆë‹¤ ì²´í¬
            
            // SSE ì—°ê²°
            const eventSource = new EventSource('/api/events/stream');
            const eventsList = document.getElementById('events-list');
            const eventCount = document.getElementById('event-count');
            let eventCounter = 0;
            
            eventSource.onmessage = function(event) {
                try {
                    const data = JSON.parse(event.data);
                    console.log('SSE ì´ë²¤íŠ¸ ìˆ˜ì‹ :', data);
                    
                    // í˜„ì¬ ì¹´ë©”ë¼ì˜ ì´ë²¤íŠ¸ë§Œ í•„í„°ë§
                    if (data.camera && data.camera.id === cameraId) {
                        addEventToList(data);
                        eventCounter++;
                        eventCount.textContent = eventCounter;
                        
                        // 'í†µí–‰ëŸ‰ ë§ìŒ' ì´ë²¤íŠ¸ì¸ ê²½ìš° íŠ¹ë³„ ì²˜ë¦¬
                        if (data.type === 'traffic_heavy') {
                            console.log('ğŸš— í†µí–‰ëŸ‰ ë§ìŒ ì´ë²¤íŠ¸ ìˆ˜ì‹ :', data);
                        }
                    }
                } catch (e) {
                    console.error('ì´ë²¤íŠ¸ íŒŒì‹± ì˜¤ë¥˜:', e);
                }
            };
            
            eventSource.onerror = function(event) {
                console.error('SSE ì—°ê²° ì˜¤ë¥˜:', event);
                eventSource.close();
            };
            
            function addEventToList(event, isInitialLoad = false) {
                // ê¸°ì¡´ "ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤" ë©”ì‹œì§€ ì œê±°
                const noEvents = eventsList.querySelector('.no-events');
                if (noEvents) {
                    noEvents.remove();
                }
                
                // ì¤‘ë³µ ì´ë²¤íŠ¸ ì²´í¬ (ID ê¸°ë°˜)
                if (event.id && document.querySelector(`[data-event-id="${event.id}"]`)) {
                    console.log('ì¤‘ë³µ ì´ë²¤íŠ¸ ìŠ¤í‚µ:', event.id);
                    return;
                }
                
                const eventItem = document.createElement('div');
                eventItem.className = 'event-item';
                if (event.id) {
                    eventItem.setAttribute('data-event-id', event.id);
                }
                
                const severity = event.severity || 1;
                const severityText = ['', 'ë‚®ìŒ', 'ë³´í†µ', 'ë†’ìŒ', 'ë§¤ìš° ë†’ìŒ', 'ì¹˜ëª…ì '][severity] || 'ì•Œ ìˆ˜ ì—†ìŒ';
                
                // ì´ë²¤íŠ¸ íƒ€ì…ì— ë”°ë¥¸ ì•„ì´ì½˜, ìƒ‰ìƒ, í•œê¸€ í‘œì‹œëª… ì„¤ì •
                let eventIcon = 'ğŸ“Š';
                let eventColor = '#667eea';
                let eventTypeDisplay = event.type;
                
                if (event.type === 'traffic_heavy') {
                    eventIcon = 'ğŸš—';
                    eventColor = '#fd7e14';
                    eventTypeDisplay = 'í†µí–‰ëŸ‰ ë§ìŒ';
                } else if (event.type === 'person') {
                    eventIcon = 'ğŸ‘¤';
                    eventColor = '#28a745';
                    eventTypeDisplay = 'ì‚¬ëŒ ê°ì§€';
                } else if (event.type.includes('car')) {
                    eventIcon = 'ğŸš™';
                    eventColor = '#17a2b8';
                    eventTypeDisplay = 'ì°¨ëŸ‰ ê°ì§€';
                } else if (event.type.includes('truck')) {
                    eventIcon = 'ğŸš›';
                    eventColor = '#17a2b8';
                    eventTypeDisplay = 'íŠ¸ëŸ­ ê°ì§€';
                } else if (event.type.includes('bus')) {
                    eventIcon = 'ğŸšŒ';
                    eventColor = '#17a2b8';
                    eventTypeDisplay = 'ë²„ìŠ¤ ê°ì§€';
                } else if (event.type.includes('motorcycle')) {
                    eventIcon = 'ğŸï¸';
                    eventColor = '#6f42c1';
                    eventTypeDisplay = 'ì˜¤í† ë°”ì´ ê°ì§€';
                }
                
                // ë©”íƒ€ ì •ë³´ì—ì„œ ì¶”ê°€ ì •ë³´ ì¶”ì¶œ
                let metaInfo = '';
                if (event.metaJson) {
                    try {
                        const meta = JSON.parse(event.metaJson);
                        if (meta.vehicleCount) {
                            metaInfo = `ì°¨ëŸ‰ ${meta.vehicleCount}ëŒ€`;
                        }
                        if (meta.message) {
                            metaInfo += meta.message.includes('í…ŒìŠ¤íŠ¸') ? ' (í…ŒìŠ¤íŠ¸)' : '';
                        }
                    } catch (e) {
                        metaInfo = event.metaJson;
                    }
                }
                
                eventItem.innerHTML = `
                    <div class="event-header">
                        <span class="event-type" style="color: ${eventColor};">${eventIcon} ${eventTypeDisplay}</span>
                        <span class="event-time">${new Date(event.ts).toLocaleTimeString()}</span>
                    </div>
                    <div class="event-details">
                        <div>ì‹¬ê°ë„: <strong>${severityText}</strong></div>
                        <div>ì ìˆ˜: <span class="event-score">${(event.score * 100).toFixed(1)}%</span></div>
                        ${metaInfo ? `<div>ìƒì„¸: <strong style="color: ${eventColor};">${metaInfo}</strong></div>` : ''}
                        ${event.bbox && event.bbox.w > 0 ? `<div>ìœ„ì¹˜: (${event.bbox.x}, ${event.bbox.y}) ${event.bbox.w}Ã—${event.bbox.h}</div>` : ''}
                        <div style="font-size: 0.8em; color: #888;">ì›ë³¸ íƒ€ì…: ${event.type}</div>
                    </div>
                `;
                
                // ì´ˆê¸° ë¡œë“œ ì‹œì—ëŠ” ëì— ì¶”ê°€ (ì´ë¯¸ ì •ë ¬ë¨), ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ëŠ” ë§¨ ìœ„ì— ì¶”ê°€
                if (isInitialLoad) {
                    console.log('ì´ˆê¸° ë¡œë“œ ì´ë²¤íŠ¸ ì¶”ê°€:', event.type, event.ts);
                    eventsList.appendChild(eventItem);
                } else {
                    console.log('ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ì¶”ê°€:', event.type, event.ts);
                    // ìƒˆë¡œìš´ ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ëŠ” ë§¨ ìœ„ì— ì¶”ê°€
                    eventsList.insertBefore(eventItem, eventsList.firstChild);
                }
                
                // ì´ë²¤íŠ¸ ëª©ë¡ì´ ë„ˆë¬´ ê¸¸ì–´ì§€ë©´ ì˜¤ë˜ëœ ê²ƒ ì œê±°
                const maxEvents = 50;
                while (eventsList.children.length > maxEvents) {
                    eventsList.removeChild(eventsList.lastChild);
                }
            }
            
            // í˜ì´ì§€ ë¡œë“œ ì‹œ ê¸°ì¡´ ì´ë²¤íŠ¸ ë¡œë“œ
            fetch(`/api/events/camera/${cameraId}`)
                .then(response => {
                    console.log('ì´ë²¤íŠ¸ ë¡œë“œ ì‘ë‹µ:', response);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                    }
                    return response.json();
                })
                .then(events => {
                    console.log('ë¡œë“œëœ ì´ë²¤íŠ¸:', events);
                    
                    if (events && events.length > 0) {
                        // ì´ë²¤íŠ¸ë¥¼ ì‹œê°„ ìˆœìœ¼ë¡œ ì •ë ¬ (ìµœì‹  ìˆœ)
                        events.sort((a, b) => new Date(b.ts) - new Date(a.ts));
                        
                        // ì´ë²¤íŠ¸ ëª©ë¡ ì´ˆê¸°í™”
                        eventsList.innerHTML = '';
                        eventCounter = 0;
                        
                        // ê¸°ì¡´ ì´ë²¤íŠ¸ë“¤ì„ ìˆœì„œëŒ€ë¡œ ì¶”ê°€ (ì´ˆê¸° ë¡œë“œ)
                        events.forEach(event => {
                            addEventToList(event, true); // isInitialLoad = true
                            eventCounter++;
                        });
                        eventCount.textContent = eventCounter;
                        
                        console.log(`ì´ ${events.length}ê°œ ì´ë²¤íŠ¸ ë¡œë“œ ì™„ë£Œ`);
                    } else {
                        console.log('ë¡œë“œëœ ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤');
                        eventsList.innerHTML = '<div class="no-events">ì´ë²¤íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
                    }
                })
                .catch(error => {
                    console.error('ê¸°ì¡´ ì´ë²¤íŠ¸ ë¡œë“œ ì‹¤íŒ¨:', error);
                    // ì˜¤ë¥˜ ì‹œ ë”ë¯¸ ì´ë²¤íŠ¸ í‘œì‹œ
                    const dummyEvent = {
                        type: 'system',
                        severity: 1,
                        score: 1.0,
                        ts: new Date().toISOString(),
                        message: 'ì´ë²¤íŠ¸ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.'
                    };
                    addEventToList(dummyEvent, true);
                });
        }
        
        // ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½ í•¨ìˆ˜
        function changeCameraStatus() {
            const statusSelect = document.getElementById('statusSelect');
            const changeBtn = document.getElementById('changeStatusBtn');
            const resultDiv = document.getElementById('statusResult');
            
            const selectedStatus = statusSelect.value;
            
            if (!selectedStatus) {
                showStatusResult('ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.', 'error');
                return;
            }
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            changeBtn.disabled = true;
            changeBtn.textContent = 'ë³€ê²½ ì¤‘...';
            
            console.log('ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½ ìš”ì²­:', cameraId, selectedStatus);
            
            fetch(`/api/cameras/${cameraId}/status?status=${selectedStatus}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                console.log('ìƒíƒœ ë³€ê²½ ì‘ë‹µ:', response);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(updatedCamera => {
                console.log('ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½ ì„±ê³µ:', updatedCamera);
                showStatusResult(`âœ… ìƒíƒœ ë³€ê²½ ì„±ê³µ! ${updatedCamera.name}ì˜ ìƒíƒœê°€ ${selectedStatus}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`, 'success');
                
                // í˜ì´ì§€ì˜ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸
                updateStatusDisplay(selectedStatus);
                
                // ì„ íƒ ì´ˆê¸°í™”
                statusSelect.value = '';
                
                // 3ì´ˆ í›„ ê²°ê³¼ ë©”ì‹œì§€ ìˆ¨ê¹€
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 3000);
            })
            .catch(error => {
                console.error('ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
                showStatusResult(`âŒ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨: ${error.message}`, 'error');
            })
            .finally(() => {
                // ë²„íŠ¼ ì¬í™œì„±í™”
                changeBtn.disabled = false;
                changeBtn.textContent = 'ìƒíƒœ ë³€ê²½';
            });
        }
        
        // ìƒíƒœ ë³€ê²½ ê²°ê³¼ í‘œì‹œ í•¨ìˆ˜
        function showStatusResult(message, type) {
            const resultDiv = document.getElementById('statusResult');
            resultDiv.textContent = message;
            resultDiv.className = `status-result ${type}`;
            resultDiv.style.display = 'block';
        }
        
        // í˜ì´ì§€ì˜ ìƒíƒœ í‘œì‹œ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateStatusDisplay(newStatus) {
            const statusBadge = document.querySelector('.status-badge');
            if (statusBadge) {
                // ê¸°ì¡´ í´ë˜ìŠ¤ ì œê±°
                statusBadge.className = 'status-badge';
                
                // ìƒˆ ìƒíƒœì— ë”°ë¥¸ í´ë˜ìŠ¤ì™€ í…ìŠ¤íŠ¸ ì„¤ì •
                const statusConfig = {
                    'ONLINE': { class: 'status-online', text: 'ONLINE' },
                    'OFFLINE': { class: 'status-offline', text: 'OFFLINE' },
                    'MAINTENANCE': { class: 'status-maintenance', text: 'MAINTENANCE' },
                    'ERROR': { class: 'status-error', text: 'ERROR' },
                    'WARNING': { class: 'status-warning', text: 'WARNING' }
                };
                
                const config = statusConfig[newStatus];
                if (config) {
                    statusBadge.classList.add(config.class);
                    statusBadge.textContent = config.text;
                }
            }
            
            // í˜ì´ì§€ ë– ë‚  ë•Œ íƒ€ì´ë¨¸ ì •ë¦¬
            window.addEventListener('beforeunload', function() {
                if (streamReconnectTimer) {
                    clearTimeout(streamReconnectTimer);
                }
                if (streamCheckTimer) {
                    clearInterval(streamCheckTimer);
                }
                if (eventSource) {
                    eventSource.close();
                }
            });
        }
    </script>
</body>
</html>
