<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CCTV AI ê´€ì œ ì‹œìŠ¤í…œ</title>
    
    <!-- Leaflet CSS -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #1a1a1a;
            color: #ffffff;
        }
        
        .app-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 1rem 2rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }
        
        .app-title {
            font-size: 1.8rem;
            font-weight: 600;
        }
        
        .user-info {
            float: right;
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        .main-container {
            display: flex;
            height: calc(100vh - 80px);
        }
        
        .sidebar {
            width: 250px;
            background-color: #2d2d2d;
            padding: 1rem;
            border-right: 1px solid #444;
        }
        
        .sidebar-menu {
            list-style: none;
        }
        
        .sidebar-menu li {
            margin-bottom: 0.5rem;
        }
        
        .sidebar-menu a {
            display: block;
            padding: 0.75rem 1rem;
            color: #ffffff;
            text-decoration: none;
            border-radius: 8px;
            transition: background-color 0.3s;
        }
        
        .sidebar-menu a:hover {
            background-color: #444;
        }
        
        .sidebar-menu a.active {
            background-color: #667eea;
        }
        
        .content-area {
            flex: 1;
            padding: 2rem;
            overflow: hidden;
        }
        
        .map-container {
            background-color: #2d2d2d;
            border-radius: 12px;
            padding: 1rem;
            height: 100%;
            position: relative;
        }
        
        #map {
            height: 100%;
            border-radius: 8px;
            background-color: #1a1a1a;
        }
        
        .legend {
            position: absolute;
            top: 20px;
            
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            max-width: 400px;
        }
        

        
        .notification {
            background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
            color: white;
            padding: 1rem;
            margin-bottom: 10px;
            border-radius: 8px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.3);
            transform: translateX(100%);
            transition: transform 0.3s ease;
            animation: slideIn 0.5s ease forwards;
        }
        
        .camera-status-panel {
            position: fixed;
            top: 100px;
            left: 20px;
            z-index: 1000;
            background: rgba(45, 45, 45, 0.95);
            border-radius: 12px;
            padding: 1rem;
            border: 1px solid #667eea;
            backdrop-filter: blur(10px);
            min-width: 250px;
        }
        
        .camera-status-panel h3 {
            margin: 0 0 1rem 0;
            color: #667eea;
            font-size: 1rem;
        }
        
        .camera-status-panel select, .camera-status-panel button {
            width: 100%;
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: #333;
            border: 1px solid #555;
            border-radius: 5px;
            color: white;
        }
        
        .camera-status-panel button {
            background: #667eea;
            cursor: pointer;
            font-weight: 600;
        }
        
        .camera-status-panel button:hover {
            background: #5a6fd8;
        }
        
        .notification.show {
            transform: translateX(0);
        }
        
        .notification-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .notification-title {
            font-weight: 600;
            font-size: 1.1rem;
        }
        
        .notification-close {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0;
            width: 20px;
            height: 20px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .notification-message {
            font-size: 0.9rem;
            opacity: 0.9;
        }
        
        @keyframes slideIn {
            from { transform: translateX(100%); }
            to { transform: translateX(0); }
        }
            right: 20px;
            background-color: rgba(0,0,0,0.8);
            padding: 1rem;
            border-radius: 8px;
            z-index: 1000;
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-right: 0.5rem;
        }
        
        .status-normal { background-color: #28a745; }
        .status-alert { background-color: #dc3545; }
        .status-fault { background-color: #ffc107; }
        .status-maintenance { background-color: #17a2b8; }
        .status-warning { background-color: #fd7e14; }
        
        .pulse {
            animation: pulse 2s infinite;
        }
        
        @keyframes pulse {
            0% { opacity: 1; }
            50% { opacity: 0.5; }
            100% { opacity: 1; }
        }
        
        .camera-count {
            position: absolute;
            top: 20px;
            left: 20px;
            background-color: rgba(0,0,0,0.8);
            padding: 0.5rem 1rem;
            border-radius: 8px;
            z-index: 1000;
        }
    </style>
</head>
<body>
    <header class="app-header">
        <div class="app-title">CCTV AI ê´€ì œ ì‹œìŠ¤í…œ</div>
        <div class="user-info" th:text="${userEmail}">admin@example.com</div>
    </header>
    
    <!-- ì•Œë¦¼ ì»¨í…Œì´ë„ˆ -->
    <div class="notification-container" id="notificationContainer"></div>
    
    <!-- ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½ íŒ¨ë„ -->
    <div class="camera-status-panel">
        <h3>âš™ï¸ ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½</h3>
        <select id="statusCameraSelect">
            <option value="">ì¹´ë©”ë¼ ì„ íƒ</option>
        </select>
        <select id="statusSelect">
            <option value="">ìƒíƒœ ì„ íƒ</option>
            <option value="ONLINE">ğŸŸ¢ ì˜¨ë¼ì¸</option>
            <option value="OFFLINE">âš« ì˜¤í”„ë¼ì¸</option>
            <option value="MAINTENANCE">ğŸ”§ ì ê²€ì¤‘</option>
            <option value="ERROR">ğŸ”´ ì˜¤ë¥˜</option>
            <option value="WARNING">ğŸŸ  ê²½ê³ </option>
        </select>
        <button onclick="changeCameraStatus()">ìƒíƒœ ë³€ê²½</button>
    </div>
    
    <div class="main-container">
        <nav class="sidebar">
            <ul class="sidebar-menu">
                <li><a href="/" class="active">ëŒ€ì‹œë³´ë“œ</a></li>
                <li><a href="/cameras">ì‹¤ì‹œê°„ ëª¨ë‹ˆí„°ë§</a></li>
                <li><a href="/events">ì´ë²¤íŠ¸ ê´€ë¦¬</a></li>
                <li><a href="/videos">ì €ì¥ ì˜ìƒ</a></li>
                <li><a href="/settings">ì„¤ì •</a></li>
            </ul>
        </nav>
        
        <main class="content-area">
            <div class="map-container">
                <div class="camera-count">
                    <strong th:text="${cameras.size()}">0</strong>ê°œ ì¹´ë©”ë¼
                </div>
                
                <div class="legend">
                    <h4>ì¹´ë©”ë¼ ìƒíƒœ</h4>
                    <div class="legend-item">
                        <div class="legend-color status-normal"></div>
                        <span>ì •ìƒ (ONLINE)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color status-alert pulse"></div>
                        <span>ì˜¤ë¥˜ (ERROR)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color status-fault"></div>
                        <span>ì˜¤í”„ë¼ì¸ (OFFLINE)</span>
                    </div>
                    <div class="legend-item">
                        <div class="legend-color status-maintenance"></div>
                        <span>ì ê²€ (MAINTENANCE)</span>
                    </div>
                </div>
                
                <div id="map"></div>
            </div>
        </main>
    </div>
    
    <!-- Leaflet JS -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <script th:inline="javascript">
        // ì¹´ë©”ë¼ ë°ì´í„°ë¥¼ JavaScriptë¡œ ì „ë‹¬
        const cameras = /*[[${cameras}]]*/ [];
        
        console.log('ì¹´ë©”ë¼ ë°ì´í„°:', cameras); // ë””ë²„ê¹…ìš© ë¡œê·¸
        
        // ì§€ë„ ì´ˆê¸°í™” - ìƒˆë¡œìš´ CCTV ìœ„ì¹˜(ì¶©ì²­ë„ ì§€ì—­) ì¤‘ì‹¬ìœ¼ë¡œ ì„¤ì •
        const map = L.map('map').setView([36.85, 127.15], 11); // ì¶©ì²­ë„ ì§€ì—­ ì¤‘ì‹¬
        
        // OpenStreetMap íƒ€ì¼ ë ˆì´ì–´ ì¶”ê°€
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
            attribution: 'Â© OpenStreetMap contributors'
        }).addTo(map);
        
        // ì¹´ë©”ë¼ ì„ íƒ ì˜µì…˜ ì¶”ê°€
        const statusCameraSelect = document.getElementById('statusCameraSelect');
        cameras.forEach(camera => {
            const option = document.createElement('option');
            option.value = camera.id;
            option.textContent = camera.name;
            statusCameraSelect.appendChild(option);
        });

        
        // ì¹´ë©”ë¼ ë§ˆì»¤ ì¶”ê°€
        cameras.forEach(camera => {
            const status = camera.status;
            let iconColor, iconClass;
            
            switch(status) {
                case 'ONLINE':
                    iconColor = '#28a745';
                    iconClass = 'status-normal';
                    break;
                case 'ERROR':
                    iconColor = '#dc3545';
                    iconClass = 'status-alert pulse';
                    break;
                case 'OFFLINE':
                    iconColor = '#ffc107';
                    iconClass = 'status-fault';
                    break;
                case 'MAINTENANCE':
                    iconColor = '#17a2b8';
                    iconClass = 'status-maintenance';
                    break;
                case 'WARNING':
                    iconColor = '#fd7e14';
                    iconClass = 'status-warning pulse';
                    break;
                default:
                    iconColor = '#6c757d';
                    iconClass = '';
            }
            
            // ì»¤ìŠ¤í…€ ì•„ì´ì½˜ ìƒì„±
            const customIcon = L.divIcon({
                className: `camera-marker ${iconClass}`,
                html: `<div style="
                    width: 20px; 
                    height: 20px; 
                    background-color: ${iconColor}; 
                    border: 2px solid white; 
                    border-radius: 50%;
                    box-shadow: 0 2px 5px rgba(0,0,0,0.3);
                "></div>`,
                iconSize: [20, 20],
                iconAnchor: [10, 10]
            });
            
            // ë§ˆì»¤ ìƒì„± ë° ì¶”ê°€
            const marker = L.marker([camera.lat, camera.lng], { icon: customIcon })
                .addTo(map)
                .bindPopup(`
                    <div style="text-align: center;">
                        <h4>${camera.name}</h4>
                        <p><strong>ìƒíƒœ:</strong> ${camera.status}</p>
                        <p><strong>RTSP:</strong> ${camera.rtspUrl || 'N/A'}</p>
                        <a href="/cameras/${camera.id}" class="btn btn-primary btn-sm">ìƒì„¸ ë³´ê¸°</a>
                    </div>
                `);
            
            // ë§ˆì»¤ í´ë¦­ ì‹œ ìƒì„¸ í˜ì´ì§€ë¡œ ì´ë™
            marker.on('click', function() {
                window.location.href = `/cameras/${camera.id}`;
            });
        });
        
        // ì¹´ë©”ë¼ê°€ ì—†ì„ ê²½ìš° ê¸°ë³¸ ìœ„ì¹˜ì— ë©”ì‹œì§€ í‘œì‹œ
        if (cameras.length === 0) {
            const defaultMarker = L.marker([36.85, 127.15])
                .addTo(map)
                .bindPopup('ë“±ë¡ëœ ì¹´ë©”ë¼ê°€ ì—†ìŠµë‹ˆë‹¤.<br/>ìƒˆë¡œìš´ ì¹´ë©”ë¼ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
        }
        
        // SSE ì—°ê²°í•˜ì—¬ ì‹¤ì‹œê°„ ì´ë²¤íŠ¸ ìˆ˜ì‹ 
        function connectSSE() {
            const eventSource = new EventSource('/api/events/stream');
            
            eventSource.onmessage = function(event) {
                const data = JSON.parse(event.data);
                console.log('SSE ì´ë²¤íŠ¸ ìˆ˜ì‹ :', data);
                
                // 'í†µí–‰ëŸ‰ ë§ìŒ' ì´ë²¤íŠ¸ ì²˜ë¦¬
                if (data.type === 'traffic_heavy') {
                    showNotification('ğŸš— í†µí–‰ëŸ‰ ë§ìŒ', data.message || 'ì°¨ëŸ‰ì´ 10ëŒ€ ì´ìƒ ê°ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    
                    // ì¹´ë©”ë¼ ìƒíƒœ ì—…ë°ì´íŠ¸ (ì§€ë„ ë§ˆì»¤ ìƒ‰ìƒ ë³€ê²½)
                    updateCameraStatus(data.cameraId, 'WARNING');
                }
            };
            
            eventSource.onerror = function(error) {
                console.error('SSE ì—°ê²° ì˜¤ë¥˜:', error);
                // 5ì´ˆ í›„ ì¬ì—°ê²° ì‹œë„
                setTimeout(connectSSE, 5000);
            };
        }
        
        // ì•Œë¦¼ í‘œì‹œ í•¨ìˆ˜
        function showNotification(title, message) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = 'notification';
            
            notification.innerHTML = `
                <div class="notification-header">
                    <div class="notification-title">${title}</div>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">Ã—</button>
                </div>
                <div class="notification-message">${message}</div>
            `;
            
            container.appendChild(notification);
            
            // 10ì´ˆ í›„ ìë™ ì œê±°
            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 10000);
        }
        
        // ì¹´ë©”ë¼ ìƒíƒœ ì—…ë°ì´íŠ¸ í•¨ìˆ˜
        function updateCameraStatus(cameraId, newStatus) {
            // ì§€ë„ì—ì„œ í•´ë‹¹ ì¹´ë©”ë¼ ë§ˆì»¤ ì°¾ê¸°
            const camera = cameras.find(c => c.id === cameraId);
            if (camera) {
                camera.status = newStatus;
                
                // ë§ˆì»¤ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
                const markers = document.querySelectorAll('.camera-marker');
                markers.forEach(marker => {
                    if (marker.closest('.leaflet-marker-icon')) {
                        const markerElement = marker.closest('.leaflet-marker-icon');
                        if (markerElement) {
                            const iconDiv = markerElement.querySelector('div');
                            if (iconDiv) {
                                switch(newStatus) {
                                    case 'MAINTENANCE':
                                        iconDiv.style.backgroundColor = '#17a2b8';
                                        break;
                                    case 'WARNING':
                                        iconDiv.style.backgroundColor = '#fd7e14';
                                        break;
                                    case 'ERROR':
                                        iconDiv.style.backgroundColor = '#dc3545';
                                        break;
                                    case 'ONLINE':
                                        iconDiv.style.backgroundColor = '#28a745';
                                        break;
                                    case 'OFFLINE':
                                        iconDiv.style.backgroundColor = '#ffc107';
                                        break;
                                }
                            }
                        }
                    }
                });
            }
        }
        
        // ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½ í•¨ìˆ˜
        function changeCameraStatus() {
            const selectedCameraId = document.getElementById('statusCameraSelect').value;
            const selectedStatus = document.getElementById('statusSelect').value;
            
            if (!selectedCameraId) {
                alert('ì¹´ë©”ë¼ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            if (!selectedStatus) {
                alert('ë³€ê²½í•  ìƒíƒœë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }
            
            console.log('ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½ ìš”ì²­:', selectedCameraId, selectedStatus);
            
            fetch(`/api/cameras/${selectedCameraId}/status?status=${selectedStatus}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                }
            })
            .then(response => {
                console.log('ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½ ì‘ë‹µ:', response);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                return response.json();
            })
            .then(updatedCamera => {
                console.log('ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½ ì„±ê³µ:', updatedCamera);
                showNotification('âœ… ìƒíƒœ ë³€ê²½ ì„±ê³µ', `${updatedCamera.name}ì˜ ìƒíƒœê°€ ${selectedStatus}ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.`);
                
                // ì§€ë„ì—ì„œ ë§ˆì»¤ ìƒ‰ìƒ ì—…ë°ì´íŠ¸
                updateCameraStatus(selectedCameraId, selectedStatus);
                
                // ì„ íƒ ì´ˆê¸°í™”
                document.getElementById('statusCameraSelect').value = '';
                document.getElementById('statusSelect').value = '';
            })
            .catch(error => {
                console.error('ì¹´ë©”ë¼ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨:', error);
                showNotification('âŒ ìƒíƒœ ë³€ê²½ ì‹¤íŒ¨', error.message);
            });
        }

        // SSE ì—°ê²° ì‹œì‘
        connectSSE();
        

    </script>
</body>
</html>
